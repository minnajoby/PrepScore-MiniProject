{% extends 'profiles/dashboard_base.html' %}
{% load static %}

{% block title %}Your Dashboard{% endblock %}

{% block extra_head %}
<style>
    /* CSS for the light-themed donut chart */
    .stat-card-chart-light {
        position: relative; height: 120px; width: 120px; border-radius: 50%; display: grid; place-items: center;
    }
    .stat-card-chart-light::before {
        content: ""; position: absolute; height: 80%; width: 80%;
        background-color: #ffffff; border-radius: 50%;
    }
    .stat-card-chart-light .value-container-light {
        position: relative; font-size: 2.2rem; color: #212529;
    }
</style>
{% endblock %}


{% block dashboard_content %}

<!-- 2. MAIN PREPSCORE CARD -->
<div class="card shadow-sm h-100 p-3 mb-4">
    <div class="card-body d-flex align-items-center">
        <div class="stat-card-chart-light me-4" data-score="{{ score|default:0 }}">
            <div class="value-container-light fw-bold">0</div>
        </div>
        <div>
            <h4 class="fw-bold">Your PrepScore</h4>
            <p class="text-muted mb-0">This score represents your overall profile strength and job market readiness.</p>
        </div>
    </div>
</div>

<!-- 3. PROFILE ANALYSIS CARD (with 2-COLUMN CHART LAYOUT & RECOMMENDATIONS) -->
<div class="card shadow-sm border-0 rounded-4">
    <div class="card-header bg-light">
        <h5 class="mb-0 fw-bold">Profile Analysis</h5>
    </div>
    <div class="card-body p-4">
        
        <div class="row g-5 align-items-center">
            
            <!-- LEFT COLUMN: PROFILE BREAKDOWN (BAR CHARTS) -->
            <div class="col-lg-7">
                <h6 class="fw-bold mb-3">Profile Breakdown</h6>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1"><span class="fw-bold">Skills</span><span class="text-muted">{{ skills.count }} / 10</span></div>
                    <div class="progress" style="height: 20px;"><div class="progress-bar bg-info" style="width: calc({{ skills.count }} * 10%)">{{ skills.count }}</div></div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1"><span class="fw-bold">Education</span><span class="text-muted">{{ educations.count }} / 3</span></div>
                    <div class="progress" style="height: 20px;"><div class="progress-bar bg-success" style="width: calc({{ educations.count }} * 33.3%)">{{ educations.count }}</div></div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1"><span class="fw-bold">Experience</span><span class="text-muted">{{ experiences.count }} / 4</span></div>
                    <div class="progress" style="height: 20px;"><div class="progress-bar bg-danger" style="width: calc({{ experiences.count }} * 25%)">{{ experiences.count }}</div></div>
                </div>
                <div>
                    <div class="d-flex justify-content-between mb-1"><span class="fw-bold">Certifications</span><span class="text-muted">{{ certifications.count }} / 4</span></div>
                    <div class="progress" style="height: 20px;"><div class="progress-bar bg-warning" style="width: calc({{ certifications.count }} * 25%)">{{ certifications.count }}</div></div>
                </div>
            </div>

            <!-- RIGHT COLUMN: SCORE BREAKDOWN (PIE CHART) -->
            <div class="col-lg-5">
                <h6 class="fw-bold mb-3 text-center">Score Contribution</h6>
                <canvas id="scoreBreakdownChart"></canvas>
            </div>
        </div>

        <!-- SEPARATOR -->
        <hr class="my-4">

        <!-- === COLORFUL RECOMMENDATIONS SECTION === -->
        <!-- === CORRECTED & FINAL RECOMMENDATIONS SECTION === -->
<div class="mt-4">
    <h6 class="fw-bold d-flex align-items-center">
        <i class="bi bi-lightbulb-fill me-2 text-primary"></i>
        Top Recommendations
    </h6>
    <div class="mt-3">
        {% for suggestion in suggestions %}
            {% if 'experience' in suggestion|lower or 'project' in suggestion|lower %}
                <div class="recommendation-box bg-primary bg-opacity-10 text-primary-emphasis d-flex align-items-center mb-3">
                    <i class="bi bi-briefcase-fill me-3 fs-4"></i>
                    <div>{{ suggestion }}</div>
                </div>
            {% elif 'skill' in suggestion|lower or 'git' in suggestion|lower or 'sql' in suggestion|lower %}
                <div class="recommendation-box bg-info bg-opacity-10 text-info-emphasis d-flex align-items-center mb-3">
                    <i class="bi bi-gear-fill me-3 fs-4"></i>
                    <div>{{ suggestion }}</div>
                </div>
            {% elif 'bio' in suggestion|lower or 'headline' in suggestion|lower or 'linkedin' in suggestion|lower %}
                <div class="recommendation-box bg-warning bg-opacity-10 text-warning-emphasis d-flex align-items-center mb-3">
                    <i class="bi bi-person-badge me-3 fs-4"></i>
                    <div>{{ suggestion }}</div>
                </div>
            {% else %}
                <div class="recommendation-box bg-success bg-opacity-10 text-success-emphasis d-flex align-items-center mb-3">
                    <i class="bi bi-star-fill me-3 fs-4"></i>
                    <div>{{ suggestion }}</div>
                </div>
            {% endif %}
        {% empty %}
            <div class="recommendation-box bg-success bg-opacity-10 text-success-emphasis d-flex align-items-center">
                <i class="bi bi-check-circle-fill me-2"></i>
                <div>No specific recommendations at this time. Your profile looks great!</div>
            </div>
        {% endfor %}
    </div>
</div>

    </div>
</div>


<!-- JAVASCRIPT FOR ALL CHARTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. ANIMATE THE DONUT CHART ---
        const scoreChart = document.querySelector('.stat-card-chart-light');
        if (scoreChart) {
            const progressValue = scoreChart.querySelector('.value-container-light');
            const score = parseInt(scoreChart.dataset.score) || 0;
            let startValue = 0, endValue = score, speed = 20;
            let progress = setInterval(() => {
                startValue++;
                progressValue.textContent = `${startValue}`;
                scoreChart.style.background = `conic-gradient(#8e44ad ${startValue * 3.6}deg, #e9ecef 0)`;
                if (startValue >= endValue) clearInterval(progress);
            }, speed);
        }

        // --- 2. BUILD THE PIE CHART ---
        const pieCtx = document.getElementById('scoreBreakdownChart');
        if (pieCtx) {
            const scoreData = {{ score_contributions|safe }};
            const labels = Object.keys(scoreData);
            const data = Object.values(scoreData);
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Points Contributed',
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)', 'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
    });
</script>

{% endblock %}